version: '3.8'

services:
  # Frontend test build
  frontend-test:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:9006
        NEXT_PUBLIC_SOCKET_URL: http://localhost:9006
        NEXT_PUBLIC_APP_URL: http://localhost:9003
        NODE_ENV: production
    image: affexai-frontend:test
    container_name: affexai-frontend-test
    ports:
      - "9003:3000"
    environment:
      - NODE_ENV=production
    # Don't start automatically, just build the image
    profiles:
      - test

  # Backend test build
  backend-test:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
      args:
        NODE_ENV: production
    image: affexai-backend:test
    container_name: affexai-backend-test
    ports:
      - "9006:3001"
    environment:
      - NODE_ENV=production
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USERNAME=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=affexai
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    # Don't start automatically, just build the image
    profiles:
      - test
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:16-alpine
    container_name: affexai-postgres-test
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: affexai
    ports:
      - "5433:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: affexai-redis-test
    ports:
      - "6380:6379"
    volumes:
      - redis_test_data:/data

volumes:
  postgres_test_data:
  redis_test_data:
